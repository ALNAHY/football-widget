<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Matches widget - filtered</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;background:#0b0d10;color:#eaf0f6;margin:0;padding:18px}
  .wrap{max-width:980px;margin:0 auto}
  h1{font-size:18px;margin:0 0 8px}
  .muted{color:#9aa3ad;font-size:13px;margin-bottom:12px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .btn{background:#111417;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;color:#eaf0f6;text-decoration:none;font-size:13px;cursor:pointer}
  .list{display:grid;gap:8px}
  .match{background:#0f1316;padding:10px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.5)}
  .when{font-size:13px;color:#9aa3ad}
  .teams{font-weight:700;margin:6px 0}
  .meta{font-size:13px;color:#b8c2c8}
  .error{background:#3b1b1b;color:#ffd6d6;padding:10px;border-radius:6px}
  a.link{color:#1db954;text-decoration:none;font-size:13px}
  pre{white-space:pre-wrap;word-break:break-word;color:#9aa3ad}
</style>
</head>
<body>
<div class="wrap">
  <h1>مباريات — مختارة ومصفاة</h1>
  <div class="muted">يعرض المباريات من مصادر iCal. يجرب جلب الرابط المباشر ثم يستخرج رابط iCal من صفحة المصدر إن لزم. إن فشل بسبب CORS سيجرب proxy تلقائيا.</div>
  <div class="controls">
    <button class="btn" id="refresh">تحديث الآن</button>
    <button class="btn" id="toggle-7">أيام: 7</button>
    <div style="margin-left:auto" class="muted">مصادر قابلة للتعديل في الكود</div>
  </div>

  <div id="status" class="muted">جارٍ التحميل...</div>
  <div id="output" class="list"></div>

  <div style="margin-top:12px;color:#9aa3ad;font-size:13px">
    إذا بقيت رسالة التحميل: انسخ رابط الصفحة وارْسِل لي لأتحقق من الأخطاء في الكونسول أو من استجابة المصادر.
  </div>
</div>

<script>
/* CONFIG: عدّل هذه الروابط الى مصادر تفضلها */
const ICS_SOURCES = [
  'https://www.fixtur.es/en/team/al-hilal',        // صفحة الهلال - السكربت سيحاول استخراج ملف iCal منها
  'https://www.fixtur.es/en/team/real-madrid',
  'https://www.fixtur.es/en/team/barcelona',
  'https://www.fixtur.es/en/wedstrijden/champions-league',
  'https://pl.ecal.com/'                            // صفحة الدوري الانجليزي
];

const KEYWORDS = [
  'al hilal','النصر','الهلال','alnassr','ittihad','al ittihad','al ahli','barcelona','real madrid','clasico',
  'manchester city','man city','liverpool','chelsea','arsenal','man united','manchester united','tottenham','champions league','ucl'
];

let DAYS = 7;
const out = document.getElementById('output');
const status = document.getElementById('status');

document.getElementById('refresh').addEventListener('click', loadAll);
document.getElementById('toggle-7').addEventListener('click', ()=>{DAYS=(DAYS===7?3:7); document.getElementById('toggle-7').textContent='أيام: '+DAYS; loadAll();});

async function loadAll(){
  out.innerHTML=''; status.textContent='تحميل المصادر...';
  try{
    const allEvents = [];
    for(const src of ICS_SOURCES){
      status.textContent = 'جلب: ' + src;
      try{
        const icsText = await fetchIcsOrDiscover(src);
        const evs = parseIcs(icsText, src);
        allEvents.push(...evs);
      } catch(err){
        const eDiv = document.createElement('div');
        eDiv.className='error';
        eDiv.textContent = 'فشل عند: ' + src + ' · ' + (err.message || err);
        out.appendChild(eDiv);
      }
    }
    status.textContent = 'تصفية وعرض...';
    const filtered = filterEvents(allEvents);
    render(filtered);
    status.textContent = 'محدث — ' + new Date().toLocaleString();
  } catch(err){
    status.textContent = 'فشل عام: ' + (err.message || err);
  }
}

/* يحاول:
   1) جلب src مباشرة كـ .ics
   2) إن كانت الصفحة HTML يحاول استخراج رابط iCal (<link rel="alternate" type="text/calendar" href="...">) او اي رابط .ics في الصفحة
   3) عند فشل CORS يعيد المحاولة عبر proxy AllOrigins
*/
async function fetchIcsOrDiscover(src){
  // اذا يبدو src بالفعل رابط .ics أو ينتهي بـ .ics جربه
  if(src.trim().toLowerCase().endsWith('.ics')) return fetchWithCorsFallback(src);

  // خلاف ذلك جلب الصفحة HTML أولاً (الوصول قد يفشل CORS)
  let html;
  try{ html = await fetchWithCorsFallback(src); }
  catch(err){ throw new Error('فشل جلب صفحة المصدر: '+err.message); }

  // ابحث عن رابط .ics في HTML: عناصر link rel=alternate type="text/calendar" أو اي href يحتوي .ics
  const href = extractIcsHrefFromHtml(html, src);
  if(!href) throw new Error('لم أعثر على رابط iCal داخل صفحة المصدر');
  return await fetchWithCorsFallback(href);
}

function extractIcsHrefFromHtml(html, baseUrl){
  // بسيط: يبحث عن href="... .ics ..." او link rel alternate
  const linkMatch = html.match(/<link[^>]+rel=["']alternate["'][^>]*type=["'][^"']*calendar[^"']*["'][^>]*href=["']([^"']+)["']/i);
  if(linkMatch) return absoluteUrl(baseUrl, linkMatch[1]);
  const hrefMatch = html.match(/href=["']([^"']+\\.ics[^"']*)["']/i);
  if(hrefMatch) return absoluteUrl(baseUrl, hrefMatch[1]);
  // بعض الصفحات يولدون روابط عبر javascript، فلن يتم التقاطها هنا
  return null;
}

function absoluteUrl(base, url){
  try{ return new URL(url, base).toString(); } catch(e){ return url; }
}

async function fetchWithCorsFallback(url){
  // direct
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.text();
  } catch(e){
    // fallback proxy
    try{
      const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
      const r2 = await fetch(proxy);
      if(!r2.ok) throw new Error('Proxy HTTP '+r2.status);
      return await r2.text();
    } catch(e2){
      throw new Error('direct and proxy failed: ' + e2.message);
    }
  }
}

/* تحليل ICS مبسط لاستخراج الأحداث */
function parseIcs(txt, source){
  const lines = txt.split(/\r?\n/);
  const events = [];
  let cur = null;
  for(let line of lines){
    if(line.startsWith('BEGIN:VEVENT')){ cur = {raw:[]}; continue; }
    if(line.startsWith('END:VEVENT')){ if(cur) events.push(cur); cur=null; continue; }
    if(cur) cur.raw.push(line);
  }
  const outEv = [];
  for(const e of events){
    const obj = {summary:'',dtstart:'',dtend:'',location:'',desc:'',source};
    for(const l of e.raw){
      if(l.startsWith('SUMMARY')) obj.summary = (l.split(':').slice(1).join(':')||'').trim();
      else if(l.startsWith('DTSTART')) obj.dtstart = (l.split(':').slice(1).join(':')||'').trim();
      else if(l.startsWith('DTEND')) obj.dtend = (l.split(':').slice(1).join(':')||'').trim();
      else if(l.startsWith('LOCATION')) obj.location = (l.split(':').slice(1).join(':')||'').trim();
      else if(l.startsWith('DESCRIPTION')) obj.desc += ' ' + (l.split(':').slice(1).join(':')||'').trim();
    }
    obj.date = parseIcalDate(obj.dtstart);
    if(obj.date) outEv.push(obj);
  }
  return outEv;
}

function parseIcalDate(s){
  if(!s) return null;
  const m = s.match(/^(\d{4})(\d{2})(\d{2})(?:T(\d{2})(\d{2})(\d{2})Z?)?/);
  if(!m) return null;
  const y=+m[1],mo=+m[2]-1,d=+m[3];
  if(m[4]){
    const hh=+m[4],mm=+m[5],ss=+m[6]||0;
    const isZ=/Z$/.test(s);
    return isZ? new Date(Date.UTC(y,mo,d,hh,mm,ss)) : new Date(y,mo,d,hh,mm,ss);
  }
  return new Date(y,mo,d,12,0,0);
}

function filterEvents(events){
  const now = new Date();
  const to = new Date(now.getTime() + DAYS*24*60*60*1000);
  return events.filter(ev=>{
    if(ev.date < now) return false;
    if(ev.date > to) return false;
    const text = ((ev.summary||'') + ' ' + (ev.location||'') + ' ' + (ev.desc||'')).toLowerCase();
    for(const k of KEYWORDS) if(text.indexOf(k.toLowerCase()) !== -1) return true;
    return false;
  }).sort((a,b)=>a.date-b.date);
}

function render(events){
  out.innerHTML='';
  if(events.length===0){ out.innerHTML='<div class="muted">لا توجد مباريات مطابقة.</div>'; return; }
  for(const e of events){
    const el = document.createElement('div'); el.className='match';
    const when = document.createElement('div'); when.className='when'; when.textContent = e.date.toLocaleString();
    const teams = document.createElement('div'); teams.className='teams'; teams.textContent = e.summary || '(match)';
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = (e.location?('المكان: '+e.location+' · '):'') + 'المصدر: ' + e.source;
    el.appendChild(when); el.appendChild(teams); el.appendChild(meta);
    out.appendChild(el);
  }
}

/* run */
loadAll();
setInterval(loadAll, 10*60*1000);
</script>
</body>
</html>
